<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monero RPC Dashboard</title>
  <!-- CSS Modules -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/info-grid.css">
  <link rel="stylesheet" href="css/config.css">
  <link rel="stylesheet" href="css/block-visualization.css">
  <link rel="stylesheet" href="css/charts.css">
  <link rel="stylesheet" href="css/auth.css">
  <link rel="stylesheet" href="css/responsive.css">
</head>
<body data-theme="dark">
  <div class="container">
    <header>
      <div class="header-title-section">
        <h1 data-i18n="app.title">üîó Monero RPC Dashboard</h1>
        <div class="version-info" id="versionInfo">
          <span class="version-text" id="versionText">-</span>
          <span class="update-icon" id="updateIcon" style="display: none;" title="Update Available">‚ö†Ô∏è</span>
        </div>
      </div>
      <div class="header-actions">
        <div class="theme-language-controls">
          <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle Theme">
            üåô
          </button>
          <select class="language-select" id="languageSelect" onchange="changeLanguage(this.value)">
            <option value="">Loading...</option>
          </select>
        </div>
        <div class="status-indicator" id="statusIndicator">
          <span class="dot"></span>
          <span id="statusText" data-i18n="header.status.connecting">Connessione...</span>
        </div>
        <span id="userInfo" style="display: none; margin-right: 10px; color: var(--text-secondary); cursor: pointer; padding: 0.5rem 1rem; background: var(--info-item-bg); border-radius: 6px; border: 1px solid var(--border-color); transition: all 0.3s ease;" onclick="showProfileModal()" title="Clicca per modificare profilo"></span>
        <button id="loginBtn" class="btn btn-primary btn-sm" onclick="showLoginModal()" style="display: none;">üîê Login</button>
        <button id="logoutBtn" class="btn btn-secondary btn-sm" onclick="handleLogout()" style="display: none;">üö™ Logout</button>
        <button id="configBtn" class="btn btn-secondary btn-sm" onclick="toggleConfigPanel()" data-i18n="header.config" style="display: none;">‚öôÔ∏è Configurazione</button>
      </div>
    </header>

    <!-- Pannello Configurazione (nascosto di default) -->
    <div id="configPanel" class="config-panel admin-only" style="display: none;">
      <div class="card">
        <div class="config-header">
          <h2 data-i18n="config.title">‚öôÔ∏è Configurazione Nodo RPC</h2>
          <button class="btn btn-close" onclick="toggleConfigPanel()">‚úï</button>
        </div>
        
        <div class="config-content">
          <!-- Form Configurazione -->
          <form id="configForm" class="config-form" onsubmit="saveConfiguration(); return false;">
            <div class="form-group">
              <label for="configHost" data-i18n="config.host">Host / IP:</label>
              <input type="text" id="configHost" class="input" placeholder="192.168.100.29">
            </div>
            
            <div class="form-group">
              <label for="configPort" data-i18n="config.port">Porta:</label>
              <input type="number" id="configPort" class="input" placeholder="18081">
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="configHttps" onchange="toggleHttpsInfo()">
                <span data-i18n="config.https">Usa HTTPS</span>
              </label>
            </div>
            
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="configAuth" onchange="toggleAuthFields()">
                <span data-i18n="config.auth">Richiede Autenticazione</span>
              </label>
            </div>
            
            <div id="authFields" style="display: none;">
              <div class="form-group">
                <label for="configUsername" data-i18n="config.username">Username:</label>
                <input type="text" id="configUsername" class="input" placeholder="username" autocomplete="username">
              </div>
              
              <div class="form-group">
                <label for="configPassword" data-i18n="config.password">Password:</label>
                <input type="password" id="configPassword" class="input" placeholder="password" autocomplete="current-password">
              </div>
            </div>
            
            <div class="config-actions">
              <button type="button" class="btn btn-secondary" onclick="testConnection()" data-i18n="config.test">üîç Testa Connessione</button>
              <button type="submit" class="btn btn-primary" data-i18n="config.save">üíæ Salva e Attiva</button>
            </div>
            
            <div id="configTestResult" class="result-container"></div>
          </form>
          
          <!-- Impostazioni Auto-refresh -->
          <div class="config-section">
            <h3 data-i18n="settings.title">‚öôÔ∏è Impostazioni Generali</h3>
            
            <div class="form-group">
              <label>
                <input type="checkbox" id="autoRefreshEnabled" onchange="updateAutoRefreshSettings()">
                <span data-i18n="settings.autorefresh">Abilita auto-refresh Network Information</span>
              </label>
            </div>
            
            <div class="form-group" id="refreshIntervalGroup">
              <label for="refreshInterval" data-i18n="settings.interval">Intervallo (secondi):</label>
              <input type="number" id="refreshInterval" class="input" min="5" max="300" value="30" onchange="updateAutoRefreshSettings()">
              <small data-i18n="settings.intervalhelp">Tra 5 e 300 secondi</small>
            </div>
          </div>

          <!-- Gestione Storico Dati -->
          <div class="config-section">
            <h3>üóëÔ∏è Gestione Storico Dati</h3>
            <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 1rem;">
              Cancella tutti i dati storici salvati (statistiche di rete degli ultimi 30 giorni)
            </p>
            <button type="button" class="btn btn-danger" onclick="clearHistoricalData()">
              üóëÔ∏è Cancella Storico
            </button>
          </div>
          
          <!-- Lista Configurazioni Salvate -->
          <div class="config-list">
            <h3 data-i18n="config.saved">Configurazioni Salvate</h3>
            <div id="savedConfigs" class="saved-configs">
              <span data-i18n="config.loading">Caricamento...</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main>
      <!-- Sezione Info Generali -->
      <section class="card collapsible" data-section="network">
        <div class="card-header" onclick="toggleSection('network')">
          <h2 data-i18n="network.title">üìä Informazioni Rete</h2>
          <div class="card-preview" id="networkPreview">
            <span class="preview-item">
              <span class="preview-label" data-i18n="network.height">Height:</span>
              <span class="preview-value" id="previewHeight">-</span>
            </span>
            <span class="preview-separator">|</span>
            <span class="preview-item">
              <span class="preview-label" data-i18n="network.sync">Sync:</span>
              <span class="preview-value" id="previewSync">-</span>
            </span>
            <span class="preview-separator">|</span>
            <span class="preview-item">
              <span class="preview-label" data-i18n="network.connections">Conn:</span>
              <span class="preview-value" id="previewConnections">-</span>
            </span>
          </div>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="networkContent">
          <div class="info-grid">
          <div class="info-item">
            <span class="label" data-i18n="network.height">Altezza Blockchain:</span>
            <span class="value" id="blockHeight">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="network.blockcount">Numero Blocchi:</span>
            <span class="value" id="blockCount">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="network.connections">Connessioni:</span>
            <span class="value" id="connections">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="network.difficulty">Difficolt√†:</span>
            <span class="value" id="difficulty">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="network.version">Versione:</span>
            <span class="value" id="version">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="network.sync">Stato Sync:</span>
            <span class="value" id="syncStatus">-</span>
          </div>
          </div>
          <button class="btn btn-primary" onclick="loadNetworkInfo()" data-i18n="network.refresh">üîÑ Aggiorna</button>
        </div>
      </section>

      <!-- Sezione Grafici Real-Time -->
      <section class="card collapsible" data-section="charts">
        <div class="card-header" onclick="toggleSection('charts')">
          <h2 data-i18n="charts.title">üìà Statistiche Real-Time</h2>
          <div class="card-preview" id="chartsPreview">
            <span class="preview-item ws-status-indicator">
              <span class="ws-dot" id="wsIndicator"></span>
              <span class="preview-value" id="wsStatusText">Connecting...</span>
            </span>
            <span class="preview-separator">|</span>
            <span class="preview-item">
              <span class="preview-label">Last Update:</span>
              <span class="preview-value" id="lastUpdateTime">-</span>
            </span>
          </div>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="chartsContent">
          <!-- Real-time Stats Cards -->
          <div class="realtime-stats-grid">
            <div class="stat-card">
              <div class="stat-label" data-i18n="charts.height">Height</div>
              <div class="stat-value" id="realtimeHeight">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label" data-i18n="charts.hashrate">Hashrate</div>
              <div class="stat-value" id="realtimeHashrate">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label" data-i18n="charts.difficulty">Difficulty</div>
              <div class="stat-value" id="realtimeDifficulty">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label" data-i18n="charts.txpool">TX Pool</div>
              <div class="stat-value" id="realtimeTxPool">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label" data-i18n="charts.incoming">Incoming</div>
              <div class="stat-value" id="realtimeIncoming">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label" data-i18n="charts.outgoing">Outgoing</div>
              <div class="stat-value" id="realtimeOutgoing">-</div>
            </div>
          </div>

          <!-- Charts Grid -->
          <div class="charts-grid">
            <div class="chart-container">
              <h3 data-i18n="charts.hashrate_history">Network Hashrate</h3>
              <div class="chart-wrapper">
                <canvas id="hashrateChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <h3 data-i18n="charts.connections_history">Connessioni</h3>
              <div class="chart-wrapper">
                <canvas id="connectionsChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <h3 data-i18n="charts.difficulty_history">Difficolt√† Rete</h3>
              <div class="chart-wrapper">
                <canvas id="difficultyChart"></canvas>
              </div>
            </div>
            <div class="chart-container">
              <h3 data-i18n="charts.txpool_history">Transaction Pool</h3>
              <div class="chart-wrapper">
                <canvas id="txpoolChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Sezione Altre Informazioni -->
      <section class="card collapsible" data-section="details">
        <div class="card-header" onclick="toggleSection('details')">
          <h2 data-i18n="details.title">üìã Altre Informazioni</h2>
          <div class="card-preview" id="detailsPreview">
            <span class="preview-item">
              <span class="preview-label" data-i18n="details.freespace">Free:</span>
              <span class="preview-value" id="previewFreeSpace">-</span>
            </span>
            <span class="preview-separator">|</span>
            <span class="preview-item">
              <span class="preview-label" data-i18n="details.dbsize">DB:</span>
              <span class="preview-value" id="previewDbSize">-</span>
            </span>
            <span class="preview-separator">|</span>
            <span class="preview-item">
              <span class="preview-value" id="previewUptime">-</span>
            </span>
          </div>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="detailsContent">
          <div class="info-grid">
          <div class="info-item">
            <span class="label" data-i18n="details.freespace">Spazio Libero:</span>
            <span class="value" id="freeSpace">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="details.dbsize">Dimensione Database:</span>
            <span class="value" id="dbSize">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="details.txcount">Totale Transazioni:</span>
            <span class="value" id="txCount">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="details.txpool">TX in Pool:</span>
            <span class="value" id="txPoolSize">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="details.uptime">Uptime Nodo:</span>
            <span class="value" id="uptime">-</span>
          </div>
          <div class="info-item">
            <span class="label" data-i18n="details.update">Aggiornamento:</span>
            <span class="value" id="updateStatus">-</span>
          </div>
        </div>
        </div>
      </section>

      <!-- Sezione Visualizzazione Blocco -->
      <section class="card collapsible" id="blockVisualization" data-section="blockvis" style="display: none;">
        <div class="card-header" onclick="toggleSection('blockvis')">
          <h2 data-i18n="blockvis.title">üß™ Visualizzazione Blocco</h2>
          <div class="card-preview" id="blockvisPreview">
            <span class="preview-item">
              <span class="preview-label" data-i18n="blockvis.txpool">TX Pending:</span>
              <span class="preview-value" id="previewTxPending">-</span>
            </span>
          </div>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="blockvisContent">
          <div class="block-container">
          <div class="block-wrapper">
            <div class="block-frame" id="blockFrame">
              <div class="tx-container" id="txContainer"></div>
            </div>
            <div class="block-info">
              <span class="block-label" data-i18n="blockvis.height">Altezza Blockchain:</span>
              <span class="block-value" id="blockVisHeight">-</span>
            </div>
          </div>
          <div class="block-stats">
            <div class="stat-item">
              <span class="stat-label" data-i18n="blockvis.txpool">TX in Attesa:</span>
              <span class="stat-value" id="blockVisTxCount">0</span>
            </div>
          </div>
        </div>
        </div>
      </section>

      <!-- Sezione Ricerca Blocco -->
      <section class="card collapsible collapsed" data-section="blocksearch">
        <div class="card-header" onclick="toggleSection('blocksearch')">
          <h2 data-i18n="block.title">üîç Ricerca Blocco</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="blocksearchContent" style="display: none;">
        <div class="search-form">
          <input 
            type="text" 
            id="blockInput" 
            data-i18n-placeholder="block.search.placeholder"
            placeholder="Inserisci altezza blocco o hash..."
            class="input"
          >
          <button class="btn btn-primary" onclick="searchBlock()" data-i18n="block.search.button">Cerca</button>
        </div>
        <div id="blockResult" class="result-container"></div>
        </div>
      </section>

      <!-- Sezione Transaction Pool -->
      <section class="card collapsible collapsed" data-section="txpool">
        <div class="card-header" onclick="toggleSection('txpool')">
          <h2 data-i18n="txpool.title">üí± Transaction Pool</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="txpoolContent" style="display: none;">
        <button class="btn btn-secondary" onclick="loadTransactionPool()" data-i18n="txpool.load">
          Carica Transazioni in Attesa
        </button>
        <div id="txPoolResult" class="result-container"></div>
        </div>
      </section>

      <!-- Sezione Chiamata RPC Personalizzata -->
      <section class="card collapsible collapsed" data-section="customrpc">
        <div class="card-header" onclick="toggleSection('customrpc')">
          <h2 data-i18n="rpc.title">‚öôÔ∏è Chiamata RPC Personalizzata</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="customrpcContent" style="display: none;">
        <div class="rpc-form">
          <label for="rpcMethod" data-i18n="rpc.method">Metodo:</label>
          <input 
            type="text" 
            id="rpcMethod" 
            data-i18n-placeholder="rpc.method.placeholder"
            placeholder="es: get_block_count"
            class="input"
          >
          
          <label for="rpcParams" data-i18n="rpc.params">Parametri (JSON):</label>
          <textarea 
            id="rpcParams" 
            placeholder='{"param": "value"}'
            class="textarea"
            rows="4"
          ></textarea>
          
          <button class="btn btn-primary" onclick="executeRPC()" data-i18n="rpc.execute">Esegui</button>
        </div>
        <div id="rpcResult" class="result-container"></div>
        </div>
      </section>

      <!-- Sezione Fee Estimate -->
      <section class="card collapsible collapsed" data-section="feeestimate">
        <div class="card-header" onclick="toggleSection('feeestimate')">
          <h2 data-i18n="fee.title">üí∞ Stima Fee</h2>
          <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="card-content" id="feeestimateContent" style="display: none;">
        <button class="btn btn-secondary" onclick="loadFeeEstimate()" data-i18n="fee.button">
          Ottieni Stima Fee
        </button>
        <div id="feeResult" class="result-container"></div>
        </div>
      </section>
    </main>

    <footer>
      <p>Monero RPC Web Interface | Built with Node.js & Express</p>
    </footer>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üîê Login</h2>
        <button class="btn btn-close" onclick="hideLoginModal()">‚úï</button>
      </div>
      <form onsubmit="handleLoginSubmit(event)">
        <div class="form-group">
          <label for="loginUsername">Username:</label>
          <input type="text" id="loginUsername" class="input" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="loginPassword">Password:</label>
          <input type="password" id="loginPassword" class="input" required autocomplete="current-password">
        </div>
        <div id="loginError" class="error-message"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideLoginModal()">Annulla</button>
          <button type="submit" class="btn btn-primary">Login</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üë§ Modifica Profilo</h2>
        <button class="btn btn-close" onclick="hideProfileModal()">‚úï</button>
      </div>
      <form onsubmit="handleProfileUpdate(event)">
        <div class="form-group">
          <label for="profileUsername">Username:</label>
          <input type="text" id="profileUsername" class="input" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="profileCurrentPassword">Password Attuale:</label>
          <input type="password" id="profileCurrentPassword" class="input" required autocomplete="current-password">
        </div>
        <div class="form-group">
          <label for="profileNewPassword">Nuova Password (lascia vuoto per non cambiare):</label>
          <input type="password" id="profileNewPassword" class="input" autocomplete="new-password">
        </div>
        <div class="form-group">
          <label for="profileConfirmPassword">Conferma Nuova Password:</label>
          <input type="password" id="profileConfirmPassword" class="input" autocomplete="new-password">
        </div>
        <div id="profileError" class="error-message"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="hideProfileModal()">Annulla</button>
          <button type="submit" class="btn btn-primary">Salva Modifiche</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Socket.IO Client -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  
  <!-- App Scripts -->
  <!-- App Scripts -->
  <script src="i18n.js"></script>
  <script src="auth.js"></script>
  <script src="charts.js"></script>
  <script src="websocket.js"></script>
  <script src="app.js"></script>
  
  <script>
    // Inizializza grafici, WebSocket e autenticazione al caricamento
    document.addEventListener('DOMContentLoaded', async () => {
      // Verifica sessione
      await checkSession();
      
      // Carica notifiche
      await loadNotifications();
      
      // Inizializza grafici e WebSocket
      setTimeout(() => {
        initCharts();
        initWebSocket();
      }, 1000);
      
      // Aggiorna notifiche ogni 30 secondi
      setInterval(loadNotifications, 30000);
    });
  </script>
</body>
</html>
